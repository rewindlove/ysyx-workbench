<<<<<<< HEAD
all:
	@echo "Write this Makefile by your self."
#MKFILE=obj_dir/Vtop.mk
#NAME=Vtop
VERILATOR=verilator 
#VSRCS = $(shell find $(abspath ./vsrc) -name "*.v")
#CSRCS = $(shell find $(abspath ./csrc) -name "*.c" -or -name "*.cc" -or -name "*.cpp")
  
sim:
	$(call git_commit, "sim RTL") # DO NOT REMOVE THIS LINE!!!
	$(VERILATOR) --trace -cc --exe --build -j vsrc/top.v csrc/main.cpp
wave: sim
	./obj_dir/Vtop
	gtkwave dump.vcd
 
clean:
	rm -rf obj_dir
	rm dump.vcd
 
 
 
include ../Makefile
=======
CC = gcc

# 目录以及文件
WORK_DIR = $(shell pwd)
BUILD_DIR = $(WORK_DIR)/build
OBJ_DIR = $(BUILD_DIR)/obj_dir
BIN = $(BUILD_DIR)/$(TOPNAME)

default:$(BIN)

$(shell mkdir -p $(BUILD_DIR))

INC_PATH := $(WORK_DIR)/csrc/include $(WORK_DIR)/csrc/src/isa/include $(INC_PATH)
INCLUDES  = $(addprefix -I, $(INC_PATH))
CFLAGS   := -O2 -MMD -Wall -Og $(INCLUDES) $(CFLAGS)
CFLAGS   += -ggdb3 -g
CFLAGS   +=

#CFLAGS   += $(shell llvm-config --cxxflags) -fPIE #CXXFLAG

LDFLAGS  += $(shell sdl2-config --libs) -lSDL2_image
LDFLAGS  += $(shell llvm-config --libs)
LDFLAGS  += -O2 -Og -ggdb3 -ldl -pie -lreadline

# Include variables and rules generated by menuconfig
-include $(NPC_HOME)/csrc/include/config/auto.conf
-include $(NPC_HOME)/csrc/include/config/auto.conf.cmd


# Include all filelist.mk to merge file lists
FILELIST_MK = $(shell find ./csrc -name "filelist.mk")
include $(FILELIST_MK)

CSRCS += $(SRCS-y)
CSRCS += $(shell find $(DIRS) -name "*.cpp" -or -name "*.cc" -or -name "*.c")



VSRCS = $(shell find $(abspath ./vsrc) -name "*.v" -or -name "*.sv")
#CSRCS = $(shell find $(abspath ./csrc) -name "*.cpp" -or -name "*.cc" -or -name "*.c")

test_CSRCS = /home/lius/ysyx-workbench/npc/test/main.cpp

TOPNAME = ysyx_23060278_top

VERILATOR_FLAGS += $(addprefix -LDFLAGS , $(LDFLAGS))
VERILATOR_FLAGS += $(addprefix -CFLAGS , $(CFLAGS))
VERILATOR = verilator
VERILATOR_FLAGS +=-Wall --cc --trace
VERILATOR_FLAGS += -O3 --x-assign fast --x-initial fast --noassert
VERILATOR_FLAGS += -MMD --build 
#VERILATOR_FLAGS += -j$(shell nproc)	#多核心编译

IMG ?=

override ARGS ?= --log=$(BUILD_DIR)/npc-log.txt
override ARGS += --diff=$(NEMU_HOME)/build/riscv32-nemu-interpreter-so
override ARGS += -b
NPC_FLAGS += $(ARGS)
NPC_FLAGS += $(IMG)

include $(NPC_HOME)/scripts/config.mk
include $(NPC_HOME)/scripts/build.mk

$(BIN):$(VSRCS) $(CPPSRCS) $(CSRCS) $(CXXSRCS)
	@rm -rf $(OBJ_DIR)
	$(VERILATOR) $(VERILATOR_FLAGS) \
		--top-module $(TOPNAME) $^ \
		--Mdir $(OBJ_DIR) --exe -o $(abspath $(BIN))

test:$(VSRCS) $(CPPSRCS) $(test_CSRCS)
	@rm -rf $(OBJ_DIR)
	$(VERILATOR) $(VERILATOR_FLAGS) \
		--top-module $(TOPNAME) $^ \
		--Mdir $(OBJ_DIR) --exe -o $(abspath $(BIN))
	./build/$(TOPNAME)

all:default

sim:$(BIN)
	$(call git_commit, "sim RTL") #DO NOT REMOVE THIS LINE!!!
	@$^ $(NPC_FLAGS)

run:sim
	$(call git_commit, "run NPC") #DO NOT REMOVE THIS LINE!!!

wave:sim
	gtkwave dump.vcd

gdb:$(BIN)
	@gdb --args $(BIN) $(NPC_FLAGS)

count_csrc:
	find csrc/ -type f -name "*.c" -exec wc -l {} +

count_vsrc:
	find vsrc/ -type f -name "*.v" -exec wc -l {} +

clean:
	rm -rf $(BUILD_DIR)
	rm -f dump.vcd

.PHONY: default all sim wave run clean test

>>>>>>> pa2
